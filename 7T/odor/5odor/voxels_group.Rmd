---
title: "Voxel_group"
author: "Fei"
date: "`r Sys.time()`"
output: html_document
params:
    path: "/Volumes/WD_E/gufei/7T_odor"
    sub: !r c(sprintf('S%02d',c(4:11,13,14,16:18)))
    thr: 2.178813
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(warning = F, message = F, cache = TRUE,tidy=F,fig.align='center',fig.showtext=TRUE,results="hold",fig.show = "hold")
library(bruceR)
library(psych)
library(ggplot2)
library(ggthemr)
library(RColorBrewer)
library(ggpubr)
library(ggrepel)
library(R.matlab)
library(plyr)
library(dplyr)
library(tidyr)
library(ggprism)
library(patchwork)
library(gridExtra)
ggthemr('fresh',layout = "clean")
```

# odor_va not excluded
```{r}
####################################################
# function to load txt file
####################################################
extractdata <- function(path,sub,txtname){
  data <- read.table(file.path(path,sub,txtname))
  # add subject name to the first column
  data <- cbind(rep(sub,times=nrow(data)),data)
  return(data)
}
####################################################
# function to calculate activated voxels
####################################################
calcact <- function(results,roilist,threshold){
  c <- 4
  data <- data.frame(matrix(ncol = 3+c*2, nrow = 0))
  
  for (roi_i in names(roilist)) {
  # select ROI
  roi_label <- roilist[[roi_i]]
  results_r <- subset(results,roi %in% roi_label,select = c(10:13))
  subs <- subset(results,roi %in% roi_label,select = 1)
  # check if activated
  results_r <- ifelse(abs(results_r)>threshold,1,0)
  act <- cbind(subs,rep(1,times=nrow(subs)),results_r)
  # calculate number and ratio
  number <- aggregate(.~sub, act, sum)
  ratio <- aggregate(.~sub, act, mean)
  # add roi name
  act <- cbind(rep(roi_i,times=nrow(number)),number,ratio[c(3:(2+c))])
  data <- rbind(data,act)
  }
  # change column names
  names(data)[1:3] <- c("roi","sub","all")
  names(data)[c(4:(3+c))] <- str_replace(names(data)[c(4:(3+c))],"t_","c_")
  names(data)[c((4+c):(3+c+c))] <- str_replace(names(data)[c((4+c):(3+c+c))],"t_","r_")
  # change to percentage
  data[c((4+c):(3+c+c))] <- data[c((4+c):(3+c+c))]*100
  data <- reshape2::melt(data,c("sub","roi"))
  return(data)
}
# odor pairs
opair <- c("car-lim","cit-lim","lim-tra","lim-ind")
# roi labels
roi_name <- c("Amy","BaLa","CeMe","Cortical",'Pir_new','Pir_old','APC_new','APC_old','PPC')
A <- c(1,3,5,6,7,8,9,15)
B <- c(1,3,8,15)
Ce <- c(5,6)
Co <- c(7,9)
Pn <- c(21,22,29)
Po <- c(21,22)
An <- c(21,29)
Ao <- 21
PPC <- 22
roilist <- list(Amy=A,BaLa=B,CeMe=Ce,Cortical=Co,Pir_new=Pn,Pir_old=Po,APC_new=An,APC_old=Ao,PPC=PPC)
```


```{r}
# sub i j k roi 4mean 4t-value
results <- data.frame(matrix(ncol = 1+12, nrow = 0))
# extract group results
results <- rbind(results,extractdata(params$path,"group","stats_results.txt"))
names(results) <- c("sub","i","j","k","roi",paste("m",opair,sep = "_"),paste("t",opair,sep = "_"))
results <- as.data.table(results)
```

# activated voxels
```{r fig.height=5, fig.width=12}
data_act <- calcact(results,roilist,params$thr)
s <- c("all",paste0("c_",opair))
data_act_mean <- describeBy(data_act$value,list(data_act$variable,data_act$roi),mat=T)
data_act_mean <- subset(data_act_mean,select = c(group1,group2,mean,se))
names(data_act_mean) <- c("voxels","roi","mean","se")
data_act_mean <- mutate(data_act_mean,roi = factor(roi,levels=roi_name))
datachosen <- subset(data_act_mean,voxels %in% s)
datachosen <- mutate(datachosen,voxels = factor(voxels,levels=s,labels = c("all",opair)))
# plot
gf_color <- c("#f0803b","#56a2d4","#ECB556","#55b96f","#777DDD")
figure <- ggplot(datachosen, aes(x=roi, y=mean, fill=voxels)) + 
  labs(x='ROI',y='Count',fill='voxels')+#设置坐标轴
  geom_bar(position="dodge", stat="identity") +
  scale_y_continuous(expand = c(0,0))+
  scale_fill_manual(values=gf_color)+ #颜色
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.2,color='black',
                position=position_dodge(.9))+
  theme_prism(base_line_size = 0.5)
print(figure)

# ratio
s <- c(paste0("r_",opair))
datachosen <- subset(data_act_mean,voxels %in% s)
datachosen <- mutate(datachosen,voxels = factor(voxels,levels=s,labels = opair))
# plot
gf_color <- c("#56a2d4","#ECB556","#55b96f","#777DDD")
figure <- ggplot(datachosen, aes(x=roi, y=mean, fill=voxels)) + 
  labs(x='ROI',y='Percentage',fill='voxels')+#设置坐标轴
  geom_bar(position="dodge", stat="identity") +
  scale_y_continuous(expand = c(0,0))+
  scale_fill_manual(values=gf_color[1:4])+ #颜色
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.2,color='black',
                position=position_dodge(.9))+
  theme_prism(base_line_size = 0.5)
print(figure)
```
