---
title: "Diffmap"
author: "Fei"
date: "`r Sys.time()`"
output: html_document
params:
    path: "/Volumes/WD_E/gufei/7T_odor/stats"
    roi: !r c('Amy9_align',paste0('Amy_align',c(1,3,5:10,15),'seg'))
    sub: !r c("S01_yyt",sprintf('S%02d',c(1:3)))
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(warning = F, message = F, cache = TRUE,tidy=F,fig.align='center',fig.showtext=TRUE,results="hold",fig.show = "hold")
library(bruceR)
library(psych)
library(ggplot2)
library(ggthemr)
library(RColorBrewer)
library(ggpubr)
library(ggrepel)
library(plotly)
library(R.matlab)
library(plyr)
library(dplyr)
library(tidyr)
library(ggprism)
ggthemr('fresh',layout = "clean")
```

```{r}
####################################################
# function to extract beta difference from txt file
####################################################
extractdata <- function(path,sub){
data <- read.table(file.path(path,sub,"sAmy_betadiff.txt"))
# add subject name to the first column
data <- cbind(rep(sub,times=nrow(data)),data)
return(data)
}
####################################################
# function to plot beta difference map
####################################################
plotmap <- function(data,var,ys, ...){
  # add x and y to data
  voxels <- nrow(data)
  xs <- ceiling( voxels/ys )
  x = as.numeric( rep(1:xs,each=ys)[1:voxels] )
  y = as.numeric( rep(1:ys,times=xs)[1:voxels] )
  data <- cbind(data,x,y)
  # plot
  ggplot(data, aes(x,y))+
    geom_raster(aes_(fill=as.name(var)))+
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0), trans = 'reverse') +
    theme(panel.border = element_rect(size = 0,fill=NA),
          plot.title = element_text(size = rel(1.2)),
          axis.text = element_blank(),
          axis.title = element_blank(),
          axis.ticks = element_blank(),
          legend.title = element_blank(),
          axis.line=element_blank(),
          legend.position = "right")
}
```


```{r}
# sub i j k roi 6beta 6t
data_diff <- data.frame(matrix(ncol = 1+16, nrow = 0))
opair <- c("lim-tra","car-tra","cit-tra","car-lim","cit-lim","car-cit")
# extract data for each subject
for (sub_i in params$sub) {
  data_diff <- rbind(data_diff,extractdata(params$path,sub_i))
}
names(data_diff) <- c("sub","i","j","k","roi",paste("b",opair,sep = "_"),paste("t",opair,sep = "_"))
data_diff <- as.data.table(data_diff)

```

```{r}
# row numbers
ys <- 50
for (sub_i in params$sub) {
  data_diff_i <- subset(data_diff,sub == sub_i)
  data_diff_i$`b_lim-tra` <- -data_diff_i$`b_lim-tra`
  for (op in opair) {
    op <- ifelse(op=="lim-tra","tra-lim",op)
    figure <- plotmap(data_diff_i,paste0("b_",op),ys) +
        # scale_fill_distiller(palette="Greens", direction=1,limits=c(-2, 2) )
      labs(title = paste(sub_i,op,sep = "_"))+
      scale_fill_gradient2(low="blue", high="red",midpoint = 0, 
        limits=c(-2, 2),oob = scales::squish)
    print(figure)
  }
}
```

